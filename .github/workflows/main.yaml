name: Update database

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 * * * *'

jobs:
  Update_json:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4 
      - uses: mlugg/setup-zig@v1
      - name: download jsons
        run: |
          wget -O ./scripts/a.json "https://api.github.com/search/repositories?q=topic:zig-package+fork:true&page=1&per_page=100"
          wget -O ./scripts/b.json "https://api.github.com/search/repositories?q=topic:zig-package+fork:true&page=2&per_page=100"
          wget -O ./scripts/c.json "https://api.github.com/search/repositories?q=topic:zig-package+fork:true&page=3&per_page=100"
          wget -O ./scripts/d.json "https://api.github.com/search/repositories?q=topic:zig-package+fork:true&page=4&per_page=100"
      - name: Compile zig files
        run: |
          zig build-exe ./scripts/databaseCompiler.zig
          zig cc -o compressor ./scripts/repoListCompressor.zig
      - name: Update main.json
        run: ./databaseCompiler > ./database/main.json
      - name: Get latest json files for the games, web and gui
        run: sh ./scripts/featured.sh
      - name: Compress web.json
        run: ./compressor ./web.json > ./database/web.json
      - name: Compress gui.json
        run: ./compressor ./gui.json > ./database/gui.json
      - name: Compress games.json
        run: ./compressor ./games.json > ./database/games.json
      - name: Remove unimportant files
        run: |
          rm -rf ./scripts/a.json
          rm -rf ./scripts/b.json
          rm -rf ./scripts/c.json
          rm -rf ./scripts/d.json
          rm -rf ./databaseCompiler
          rm -rf ./databaseCompiler.o
          rm -rf ./gui.json
          rm -rf ./games.json
          rm -rf ./web.json
          rm -rf ./compressor
      - name: Config email
        run: git config --global user.name "Github Actions" && git config --global user.email "<>"
      - name: Git add
        run: git add .
      - name: Commit images
        run: git commit -m '[CI] Updated database'
      - name: Push changes
        run: git push
